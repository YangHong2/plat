<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhlk.subcontract.dao.DevProduceDao">
    <resultMap type="com.dhlk.entity.sub.DevProduce" id="DevProduceMap">
        <result property="id" column="id" jdbcType="INTEGER"/>
        <result property="progress" column="progress" jdbcType="VARCHAR"/>
        <result property="weeklyReports" column="weekly_reports" jdbcType="VARCHAR"/>
        <result property="createTime" column="create_time" jdbcType="TIMESTAMP"/>
        <result property="projectId" column="project_id" jdbcType="INTEGER"/>
        <result property="companyId" column="company_id" jdbcType="INTEGER"/>
        <result property="type" column="type" jdbcType="INTEGER"/>
        <collection property="file"  column="attachment_addr" select="com.dhlk.subcontract.dao.AttachmentDao.findByDataId"/>
    </resultMap>


    <!--新增所有列-->
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
            insert into dhlk_subcontract_plat.dev_produce(progress, weekly_reports, create_time, project_id,company_id,type)
            values (#{progress}, #{weeklyReports}, #{createTime}, #{projectId},#{companyId},#{type})
    </insert>


    <!--通过主键修改数据-->
    <update id="update">
        update dhlk_subcontract_plat.dev_produce
        <set>
            <if test="progress != null and progress != ''">
                progress = #{progress},
            </if>
            <if test="weeklyReports != null">
                weekly_reports = #{weeklyReports},
            </if>
            <if test="projectId != null">
                project_id = #{projectId},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--通过主键删除-->
    <delete id="delete" parameterType="java.util.List">
        delete from  dhlk_subcontract_plat.dev_produce where id  in
        <foreach collection="list" open="(" separator="," close=")" item="item">
            #{item}
        </foreach>
    </delete>

    <select id="findConstruction" resultMap="DevProduceMap">
        SELECT
        t3.*,
        IFNULL('施工','') as types,
        t4.id AS financial,
        t5.id AS consulting,
        t6.id AS delivery,
        t7.id AS proClose
        FROM
        ( SELECT t2.* FROM dev_produce t1 JOIN project_issue t2 ON t1.project_id = t2.id and t1.company_id = #{companyId}  and t1.type = 1) t3
        LEFT JOIN financial_provider t4 ON t3.id = t4.project_id
        LEFT JOIN consulting_provider t5 ON t3.id = t5.project_id
        LEFT JOIN delivery_apply_for t6 ON t3.id = t6.project_id and t6.type = 1
        LEFT JOIN project_close t7 ON t3.id = t7.project_id AND t7.audit_result = 2
        WHERE 1=1
        <if test="name != null and name != ''">
            and t3.project_name  like concat('%/', #{name}, '%') ESCAPE '/'
        </if>
        order by t3.id desc
    </select>

    <select id="findByProjectId" resultMap="DevProduceMap">
        SELECT
        t1.id,
        t1.progress,
        t1.weekly_reports,
        t1.create_time,
        t1.project_id,
        t1.company_id,
        t1.type
        FROM
        dev_produce t1
        WHERE  t1.project_id = #{projectId} and t1.type = 0
        order by t1.id desc
    </select>

    <select id="findInstallation" resultMap="DevProduceMap">
        SELECT
        t1.id,
        t1.progress,
        t1.weekly_reports,
        t1.create_time,
        t1.project_id,
        t1.company_id,
        t1.type
        FROM
        dev_produce t1
        WHERE  t1.project_id = #{projectId} and t1.type = 1
        order by t1.id desc
    </select>

</mapper>

